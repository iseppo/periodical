name: run-turuylevaade-daily

env:
  # Use Posit Public Package Manager for R binaries
  USE_PUBLIC_RSPM: true
  CRAN: https://cloud.r-project.org
  R_LIBS_USER: ${{ github.workspace }}/renv/library

on:
  schedule:
    - cron: '5 7 * * *'    # 10:05 EEST = 07:05 UTC
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    # 1. Checkout code
    - uses: actions/checkout@v4

    # 2. SSH key in RAM
    - uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.UPLOAD_TO_ZONE }}

    # 3. Pin host key
    - name: Add server fingerprint
      run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    # 4. Install R (with Pandoc & build tools)
    - uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: ${{ env.USE_PUBLIC_RSPM }}

    # 5. Pre-accept Microsoft Fonts EULA
    - name: Pre-accept MS Core Fonts EULA
      run: |
        echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" \
          | sudo debconf-set-selections
        export DEBIAN_FRONTEND=noninteractive
        
    # 6. System dependencies & fonts
    - name: Install system dependencies & fonts
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libcurl4-openssl-dev libssh-dev libssl-dev \
          libcairo2-dev libfontconfig1-dev libfreetype6-dev \
          libpng-dev libjpeg-dev libxml2-dev libproj-dev \
          libudunits2-dev libgdal-dev libgeos-dev \
          ttf-mscorefonts-installer fonts-liberation \
          fonts-roboto fonts-inter fonts-ibm-plex fonts-open-sans \
          pandoc \
          ffmpeg 
          
    # 7. Install Quarto CLI via official action
    - name: Install Quarto CLI
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        version: 'release'

    # --- UUS OSA: Paigaldame Rust/Cargo {gifski} paketi jaoks ---
    # See samm peab olema enne renv::restore(), et kompileerimine Ãµnnestuks
    - name: Install Rust toolchain (for Cargo)
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable

    # 8. Cache the renv library
    - name: Cache renv library
      uses: actions/cache@v4
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}
        restore-keys: |
          ${{ runner.os }}-renv-
          
    # 9. Restore R packages using renv
    - name: Restore R packages
      run: |
        Rscript -e "if (!requireNamespace('renv', quietly = TRUE)) install.packages('renv')"
        Rscript -e "renv::restore()"
        
    # 10. Register hrbrthemes fonts in R (optional)
    - name: Register hrbrthemes fonts
      run: |
        Rscript -e "options(hrbrthemes.loadfonts=TRUE); library(hrbrthemes)"
        
    # 11. Run your analysis script
    - name: Run NAV_kasv.R script
      run: Rscript NAV_kasv.R

    # 12. Run Quarto renders
    - name: Render Quarto reports
      run: |
        quarto render turuylevaade.qmd
        quarto render tuleva.qmd

    # 13. Upload files to server
    - name: Upload results to server
      run: |
        scp ./aastane_tulu_tuleva_lhv.png ./aastane_tulu_animeeritud.mp4 ./tuleva.html virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/kihlveod/
        scp ./turuylevaade.html ./koguturg_indeksfondid_osakaal.csv ./koguturg_koguinfo.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/
