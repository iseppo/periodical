# .github/workflows/run-turuylevaade-daily.yml
name: run-turuylevaade-daily

on:
  schedule:
    - cron: '5 11 * * *'
  workflow_dispatch: {}

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.UPLOAD_TO_ZONE }}

    - name: Add server fingerprint
      run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Run Analysis and Upload in Docker
      run: |
        docker run --rm \
          --env SSH_AUTH_SOCK=${{ env.SSH_AUTH_SOCK }} \
          --volume "${{ env.SSH_AUTH_SOCK }}:${{ env.SSH_AUTH_SOCK }}" \
          --volume ~/.ssh:/root/.ssh:ro \
          --volume "${{ github.workspace }}:/home/rstudio/project" \
          --workdir "/home/rstudio/project" \
          ghcr.io/iseppo/periodical:main \
          bash -c "
            echo '--- Temporarily disabling renv by renaming trigger files ---'
            # See on see meetod, mis tegelikult töötab.
            [ -f .Rprofile ] && mv .Rprofile .Rprofile.bak
            [ -d renv ] && mv renv renv.bak

            echo '--- Running R script ---'
            Rscript NAV_kasv.R
            
            echo '--- Rendering Quarto reports ---'
            quarto render turuylevaade.qmd
            quarto render tuleva.qmd

            echo '--- Fetching III sammas fund list ---'
            Rscript fetch_iii_sammas_fondid.R || echo 'III sammas fund list fetch failed, continuing...'

            echo '--- Rendering III sammas report ---'
            quarto render III_sammas.qmd || echo 'III sammas rendering failed, continuing...'
            
            echo '--- Uploading files to server ---'
            scp ./aastane_tulu_tuleva_lhv.png ./kihlvedu.png ./aastane_tulu_animeeritud.mp4 ./tuleva.html virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/kihlveod/

            scp ./turuylevaade.html ./koguturg_indeksfondid_osakaal.csv ./koguturg_koguinfo.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/

            # Upload III sammas files if they exist
            if [ -f III_sammas.html ]; then
              echo 'Uploading III sammas files...'
              scp ./III_sammas.html virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/
              [ -f iii_sammas_koguturg.csv ] && scp ./iii_sammas_koguturg.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/
              [ -f iii_sammas_top_fondid.csv ] && scp ./iii_sammas_top_fondid.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/
              # UUENDUS: Upload andmebaasi fail (kui eksisteerib)
              [ -f iii_sammas_ajalugu.csv ] && scp ./iii_sammas_ajalugu.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/ && echo 'Andmebaas üles laaditud'
              # Upload investorite ajaloo fail (kui eksisteerib)
              [ -f iii_sammas_investorid_ajalugu.csv ] && scp ./iii_sammas_investorid_ajalugu.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/ && echo 'Investorite ajalugu üles laaditud'
            fi
            
            # Lae üles tuleva_files kaust (kui eksisteerib) SÄILITADES struktuuri
            if [ -d tuleva_files ]; then
              echo 'Uploading tuleva_files directory...'
              scp -r tuleva_files \
                virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/kihlveod/
            fi            
            
            
            echo '--- Done ---'
          "
