name: run-turuylevaade-daily

on:
  # 10:05 in Tallinn = 07:05 UTC
  schedule:
    - cron: '5 7 * * *'
  workflow_dispatch: {}          # manual “Run workflow” button

jobs:
  run:
    runs-on: ubuntu-latest
env:
  RSPM:  https://packagemanager.posit.co/cran/__linux__/jammy/2025-05-08
  RENV_CONFIG_REPOS_OVERRIDE: ${{ env.RSPM }}
  RENV_CONFIG_INSTALL_PRECOMPILED: "true"
  R_LIBS_USER: ${{ github.workspace }}/renv/library
    # Mask every command’s stdout/stderr that contains a secret
    permissions:
      contents: read            # checkout code
      id-token: write           # future-proof for OIDC, not used now

    steps:
      # 1 Pull the repo
      - uses: actions/checkout@v4

      # 2 Load the deployment key into an in-memory ssh-agent
      #    – nothing ever touches the runner’s disk
      - uses: webfactory/ssh-agent@v0.9.1      # pin exact tag
        with:
          ssh-private-key: ${{ secrets.UPLOAD_TO_ZONE }}

      # 3 Trust the host fingerprint (prevents MITM & prompts)
      - name: Add server fingerprint
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

- name: Restore packages via renv
  run: |
    Rscript -e 'install.packages("renv", repos = Sys.getenv("RSPM"))'
    Rscript -e 'renv::restore(lockfile = "renv.lock", prompt = FALSE)'




      
      - name: Install required R packages
        run: |
          Rscript -e 'install.packages(
            c("ssh","tidyverse","hrbrthemes","ggfittext","tidyquant",
              "tseries","xts","plotly","ggalt","DT","jsonlite","rvest"),
            repos = "https://cloud.r-project.org", dependencies = TRUE)'

      # 5 Fire the script (it uses SSH transparently via the agent)
      - name: Run R script
        run: Rscript run_turuylevaade.R
