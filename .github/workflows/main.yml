name: run-turuylevaade-daily

env:
  RSPM: https://packagemanager.posit.co/cran/__linux__/jammy/2025-05-12
  CRAN: https://cloud.r-project.org
  RENV_CONFIG_REPOS_OVERRIDE: https://packagemanager.posit.co/cran/__linux__/jammy/2025-05-12
  RENV_CONFIG_INSTALL_PRECOMPILED: "true"
  R_LIBS_USER: ${{ github.workspace }}/renv/library

on:
  # 10:05 in Tallinn = 07:05 UTC
  schedule:
    - cron: '5 7 * * *'
  workflow_dispatch: {}          # manual “Run workflow” button

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read            # checkout code
      id-token: write           # future-proof for OIDC, not used now

    steps:
      # 1 Pull the repo
      - uses: actions/checkout@v4

      # 2 Load the deployment key into an in-memory ssh-agent
      #    – nothing ever touches the runner’s disk
      - uses: webfactory/ssh-agent@v0.9.1      # pin exact tag
        with:
          ssh-private-key: ${{ secrets.UPLOAD_TO_ZONE }}

      # 3 Trust the host fingerprint (prevents MITM & prompts)
      - name: Add server fingerprint
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # 4 install R
      - uses: r-lib/actions/setup-r@v2

      # 4 Cache R packages
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/renv/library
          key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
          restore-keys: |
            ${{ runner.os }}-renv-

      # 5 Restore packages via renv
      - name: Restore packages
        run: |
          Rscript -e 'install.packages("renv", repos = Sys.getenv("CRAN"))'
          Rscript - <<'RSCRIPT'
            repos <- c(RSPM = Sys.getenv("RSPM"), CRAN = Sys.getenv("CRAN"))
            options(repos = repos, install.packages.compile.from.source = "never")
            renv::restore(lockfile = "renv.lock", prompt = FALSE, repos = repos)
          RSCRIPT

      # 6 Install required R packages
      - name: Install required R packages
        run: |
          Rscript -e 'install.packages(
            c("ssh","tidyverse","hrbrthemes","ggfittext","tidyquant",
              "tseries","xts","plotly","ggalt","DT","jsonlite","rvest"),
            repos = Sys.getenv("RSPM"), dependencies = TRUE)'

      # 7 Fire the script (it uses SSH transparently via the agent)
      - name: Run R script
        run: Rscript run_turuylevaade.R
