# .github/workflows/run-turuylevaade-daily.yml
name: run-turuylevaade-daily

on:
  schedule:
    - cron: '5 7 * * *' # Käivitub iga päev kell 07:05 UTC
  workflow_dispatch: {} # Võimaldab manuaalset käivitamist

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.1
      with:
        ssh-private-key: ${{ secrets.UPLOAD_TO_ZONE }}

    - name: Add server fingerprint
      run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Run Analysis and Upload in Docker
      run: |
        docker run --rm \
          --env SSH_AUTH_SOCK=${{ env.SSH_AUTH_SOCK }} \
          # --- OLULINE MUUDATUS ---
          # See lülitab välja renv-i automaatse aktiveerimise,
          # sundides R-i kasutama pildi sisse ehitatud pakette.
          --env RENV_ACTIVE=FALSE \
          --volume "${{ env.SSH_AUTH_SOCK }}:${{ env.SSH_AUTH_SOCK }}" \
          --volume "${{ github.workspace }}:/home/rstudio/project" \
          --workdir "/home/rstudio/project" \
          ghcr.io/iseppo/periodical:main \
          bash -c "
            echo '--- Running R script ---'
            Rscript NAV_kasv.R
            
            echo '--- Rendering Quarto reports ---'
            quarto render turuylevaade.qmd
            quarto render tuleva.qmd
            
            echo '--- Uploading files to server ---'
            scp ./aastane_tulu_tuleva_lhv.png ./aastane_tulu_animeeritud.mp4 ./tuleva.html virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/kihlveod/
            scp ./turuylevaade.html ./koguturg_indeksfondid_osakaal.csv ./koguturg_koguinfo.csv virt135256@${{ secrets.SERVER_HOST }}:/data03/virt135256/domeenid/www.seppo.ai/htdocs/tuleva/
            
            echo '--- Done ---'
          "