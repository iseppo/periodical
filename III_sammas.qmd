---
title: "Kolmas sammas - turuülevaade"
date: today
date-format: long
lang: et_EE
format:
  html:
    toc: true
    toc-depth: 3
    toc-title: Sisukord
    toc-location: right
    number-sections: false
    number-depth: 3
    html-math-method: katex
    self-contained: true
    anchor-sections: true
    smooth-scroll: true
    theme: slate
execute:
  echo: false
  warning: false
  message: false
---



```{r setup, message=FALSE}
library(dplyr)
library(tidyr)
library(forcats)
library(ggplot2)
library(readr)
library(stringr)
library(lubridate)
library(hrbrthemes)
library(plotly)
library(jsonlite)
library(rvest)
library(furrr)
library(future)
library(parallel)
library(tibble)
```

```{r config, echo=FALSE, message=FALSE, warning=FALSE}
from_day <- "2017-05-02"
yesterday <- as.character(today() - days(1))

# Funktsioon numbrite puhastamiseks (eemaldab tühikud ja asendab koma punktiga)
puhasta_number <- function(x) {
  if(is.numeric(x)) return(x)
  if(is.character(x)) {
    # Eemaldame tühikud ja asendame koma punktiga
    x_puhastatud <- gsub(" ", "", x, fixed = TRUE)
    x_puhastatud <- gsub(",", ".", x_puhastatud, fixed = TRUE)
    # Teisendame numbriks
    return(as.numeric(x_puhastatud))
  }
  return(as.numeric(x))
}

# Funktsioon veeru leidmiseks mustri järgi
leia_veerg <- function(df, muster) {
  veerg_nimi <- grep(muster, names(df), ignore.case = TRUE, value = TRUE)
  if(length(veerg_nimi) > 0) {
    return(veerg_nimi[1])
  }
  return(NULL)
}
```


```{r fondid_online}
# Määrame fondid ja nende ID-d käsitsi, et vältida veebilehe vigadest tulenevaid probleeme.
# ID-d pärinevad Pensionikeskuse süsteemist.

fondid <- data.frame(
  id = c("78", "47", "48", "82",    # LHV
         "77", "50", "51",          # Swedbank
         "79", "44",                # SEB
         "76", "75",                # Luminor
         "80"),                     # Tuleva
  fond = c("LHV III Indeks", "LHV III Täiendav", "LHV III XL", "LHV III Roheline",
           "Swedbank III V100 Indeks", "Swedbank III V30", "Swedbank III V60",
           "SEB III Tulevik Indeks", "SEB III Aktiivne",
           "Luminor III Jätkusuutlik", "Luminor III Aktsiad 100",
           "Tuleva III"),
  indeks = c("x", "", "", "",       # Märgime indeksfondid (x)
             "x", "", "",
             "x", "",
             "x", "",
             "x"),
  stringsAsFactors = FALSE
)

# Jätame meelde ka fund_info, et ülejäänud kood katki ei läheks
fund_info <- fondid %>% rename(ID = id, Title = fond)
```

```{r fondid_csv, message=FALSE, warning=FALSE, include=FALSE}
# fondid <- read_csv("Pensionifondid_III.csv", show_col_types = FALSE)
# fondid <- data.frame()  # See rida tühjendaks fondid muutuja
# Kui fail on tühi või pole veel täidetud, kasutame veebist leitud andmeid
if(nrow(fondid) == 0 && nrow(fund_info) > 0) {
  fondid <- fund_info %>%
    rename(id = ID, fond = Title) %>%
    mutate(indeks = ifelse(
      grepl("indeks|Indeks|index|Index", fond, ignore.case = TRUE),
      "x",
      ""
    ))
} else if(nrow(fondid) > 0 && nrow(fund_info) > 0) {
  # Kui meil on CSV fail ja veebist andmed, uuendame fondide nimetusi
  fondid$fond <- NULL
  fondid <- fondid %>%
    mutate(id = as.character(id)) %>%
    left_join(select(fund_info, Title, ID), by = c("id" = "ID")) %>%
    rename(fond = Title)
}

# Kontrolli uusi fonde
puuduvad <- data.frame()
puudu <- FALSE
if(nrow(fund_info) > 0) {
  puuduvad <- fund_info %>%
    filter(!ID %in% fondid$id)
  if(nrow(puuduvad) > 0) puudu <- TRUE
}
```


```{r check_new_funds, eval = puudu}
cat("NB! meil on uusi fonde, mida kood ei arvesta:", puuduvad$Title)
```


```{r lae_alla_info, message=FALSE, warning=FALSE}
from_day <- "2017-05-02"
yesterday <- as.character(today() - days(1))

# 1. TÄIUSTATUD FUNKTSIOONID
# Eemaldab ka "hard space" (\u00a0) ja tavalised tühikud
puhasta_number <- function(x) {
  if(is.numeric(x)) return(x)
  if(is.character(x)) {
    # Asendame kõik tühiku-laadsed märgid (sh non-breaking space) tühjusega
    x_puhastatud <- gsub("\\s|\\u00a0", "", x) 
    x_puhastatud <- gsub(",", ".", x_puhastatud, fixed = TRUE)
    return(as.numeric(x_puhastatud))
  }
  return(as.numeric(x))
}

# Otsib veergu täpsema mustri järgi
leia_veerg_taern <- function(df, muster) {
  # Otsime veergu, mis sisaldab mustrit
  veerg <- grep(muster, names(df), ignore.case = TRUE, value = TRUE)
  # Välistame "Osakute arv", kui otsime kontosid
  if(grepl("konto", muster, ignore.case=TRUE)) {
     veerg <- veerg[!grepl("osak", veerg, ignore.case=TRUE)]
  }
  if(length(veerg) > 0) return(veerg[1])
  return(NULL)
}

# 2. ANDMETE LAADIMINE
available_cores <- parallel::detectCores()
worker_count <- max(1, available_cores - 1)
plan(multisession, workers = worker_count)

# Laeme KÕIKIDE fondide mahu korraga (ilma filtrita)
lae_mahud <- function() {
  url <- paste0("https://www.pensionikeskus.ee/statistika/iii-sammas/taiendava-kogumispensioni-fondide-maht/?download=xls",
                "&date_from=", from_day, "&date_to=", yesterday)

  tryCatch({
    df <- read.csv2(url, fileEncoding = "UTF-16LE", sep = "\t", header = TRUE,
                    check.names = FALSE, stringsAsFactors = FALSE)

    if("Kuupäev" %in% names(df)) df$Kuupäev <- dmy(df$Kuupäev)

    # Leiame mahtu veeru
    col_maht <- leia_veerg_taern(df, "maht")
    if(!is.null(col_maht)) {
      df$maht <- puhasta_number(df[[col_maht]])
    }

    # Lisame ISIN-i põhjal fondi ID (match with our fondid list)
    # Kui ISIN puudub, kasutame fondi nime
    return(df %>% select(Kuupäev, Fond, Lühinimi, maht))
  }, error = function(e) {
    message("Viga mahtude laadimisel: ", e$message)
    return(NULL)
  })
}

# Laeme KOGUTURU kontode arvu (see on juba summa üle kõikide fondide!)
# NB! Pensionikeskuse API ei toeta fondi-põhist kontode arvu allalaadimist.
lae_koguturu_kontod <- function() {
  url <- paste0("https://www.pensionikeskus.ee/statistika/iii-sammas/pensionikontode-arv/?download=xls",
                "&date_from=", from_day, "&date_to=", yesterday)

  tryCatch({
    df <- read.csv2(url, fileEncoding = "UTF-16LE", sep = "\t", header = TRUE,
                    check.names = FALSE, stringsAsFactors = FALSE)

    if("Kuupäev" %in% names(df)) df$Kuupäev <- dmy(df$Kuupäev)

    col <- leia_veerg_taern(df, "pensionikontode.*arv")
    if(!is.null(col)) {
      df$kontode_arv_koguturg <- puhasta_number(df[[col]])
      return(df %>% select(Kuupäev, kontode_arv_koguturg))
    }
    return(NULL)
  }, error = function(e) {
    message("Viga kontode arvu laadimisel: ", e$message)
    return(NULL)
  })
}

# Laeme andmed
raw_maht <- lae_mahud()
raw_koguturu_kontod <- lae_koguturu_kontod()

plan(sequential)

# 3. ANDMETE ÜHENDAMINE
if(!is.null(raw_maht) && nrow(raw_maht) > 0) {

  # Määrame indeksfondid otse fondide nimede põhjal
  # Pensionikeskuse andmetest
  fondid_info <- raw_maht %>%
    mutate(
      # Määrame, kas tegemist on indeksfondiga
      indeks = ifelse(
        grepl("V100|Indeks|Index|Aktiivne III|18\\+|16-50|III Samba", Fond, ignore.case = TRUE),
        "x",
        ""
      )
    )

  # Kui tahame säilitada vanu ID-sid (valikuline), siis võime proovida matchida
  # kuid see ei ole enam vajalik, kuna kasutame otse Pensionikeskuse nimesid

  # NB! Kontode arv on KOGUTURU kohta, mitte üksikute fondide kohta.
  # Pensionikeskuse API ei paku fondi-põhist kontode arvu.
  message("NB: Kontode arv on saadaval ainult koguturu kohta, mitte üksikute fondide kohta.")
  message("Laaditud fondide arv: ", length(unique(fondid_info$Fond)))

} else {
  fondid_info <- data.frame()
  message("Andmete laadimine ebaõnnestus.")
}
```




```{r filter_index_funds, message=FALSE, warning=FALSE, include=FALSE}
# Filtreerime indeksfondid, kui need on märgitud
if(nrow(fondid_info) > 0) {
  # Kasutame 'indeks' veergu, mis lisati fondid tabelist
  indeksfondid <- fondid_info %>%
    filter(!is.na(indeks) & indeks == "x")
} else {
  indeksfondid <- fondid_info
}
```


```{r set_colors, include=FALSE}
# Määrame värvid
if(nrow(indeksfondid) > 0) {
  indeksfondid_arv <- length(unique(indeksfondid$Lühinimi))
  colors <- c("#e60049", "#50e991", "#e6d800", "#9b19f5", "#ffa300", "#dc0ab4", "#b3d4ff", "#00bfa0", "#ff6e54", "#444e86")
  colors_fondid <- colors[1:min(indeksfondid_arv, length(colors))]
  names(colors_fondid) <- unique(indeksfondid$Lühinimi)
}
```


```{r date_range, include=FALSE}
if(nrow(fondid_info) > 0) {
  andmed_alates <- min(fondid_info$Kuupäev, na.rm = TRUE)
  andmed_kuni <- max(fondid_info$Kuupäev, na.rm = TRUE)
} else {
  andmed_alates <- NA
  andmed_kuni <- NA
}
```

# Kolmanda samba ülevaade

```{r print_date_range}
if(nrow(fondid_info) > 0) {
  cat("Andmed:", as.character(andmed_alates), "--", as.character(andmed_kuni), "\n")
} else {
  cat("Andmete laadimine ebaõnnestus. Palun kontrolli Pensionifondid_III.csv faili ja veendu, et seal on fondide ID-d määratud.\n\nVõid kasutada skripti fetch_iii_sammas_fondid.R fondide nimekirja hankimiseks.")
}
```

::: panel-tabset


```{r calc_totals, include=FALSE}
if(nrow(fondid_info) > 0) {
  # Arvutame kogusummad MAHU kohta
  k6ik_koos_maht <- fondid_info %>%
    group_by(Kuupäev) %>%
    summarize(
      maht_kokku = sum(maht, na.rm = TRUE)
    )

  # Lisame koguturu kontode arvu (kui see on olemas)
  if(!is.null(raw_koguturu_kontod) && nrow(raw_koguturu_kontod) > 0) {
    k6ik_koos <- k6ik_koos_maht %>%
      left_join(raw_koguturu_kontod, by = "Kuupäev") %>%
      rename(kontode_kokku = kontode_arv_koguturg)
  } else {
    k6ik_koos <- k6ik_koos_maht %>%
      mutate(kontode_kokku = NA_integer_)
  }

  if(nrow(indeksfondid) > 0) {
    indeksfondid_koos <- indeksfondid %>%
      group_by(Kuupäev) %>%
      summarize(
        maht = sum(maht, na.rm = TRUE)
      ) %>%
      left_join(k6ik_koos, by = "Kuupäev") %>%
      mutate(
        indeks_maht_protsent = round(100 * maht / maht_kokku, 1)
      )
  } else {
    indeksfondid_koos <- k6ik_koos %>%
      mutate(
        maht = 0,
        indeks_maht_protsent = 0
      )
  }
} else {
  indeksfondid_koos <- data.frame()
  k6ik_koos <- data.frame()
}
```

#### Koguturu maht

```{r plot_total_volume}
if(nrow(k6ik_koos) > 0) {
  options(scipen = 999)

  koguturu_maht <- k6ik_koos %>%
    mutate(maht_milj = round(maht_kokku / 1000000, 1)) %>%
    mutate(maht_label = format(maht_milj, big.mark = " ", decimal.mark = ","))

  p <- koguturu_maht %>%
    ggplot(aes(x = Kuupäev, y = maht_milj)) +
    geom_line() +
    theme_ft_rc() +
    geom_blank(aes(x = min(Kuupäev), y = 0)) +
    labs(title = "Kolmanda samba koguturu maht",
         x = "kuupäev",
         y = "maht (miljonit eurot)") +
    geom_point(data = filter(koguturu_maht, Kuupäev == max(Kuupäev)),
               size = 2, color = "orange") +
    geom_text(data = filter(koguturu_maht, Kuupäev == max(Kuupäev)),
              aes(label = maht_label), nudge_x = 150, color = "orange")

  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```


#### Koguturu kontod

```{r plot_total_accounts}
if(nrow(k6ik_koos) > 0) {
  options(scipen = 999)

  koguturu_kontod <- k6ik_koos %>%
    mutate(kontode_label = format(kontode_kokku, big.mark = " ", decimal.mark = ","))

  p <- koguturu_kontod %>%
    ggplot(aes(x = Kuupäev, y = kontode_kokku)) +
    geom_line() +
    theme_ft_rc() +
    geom_blank(aes(x = min(Kuupäev), y = 0)) +
    labs(title = "Kolmanda samba pensionikontode arv",
         x = "kuupäev",
         y = "pensionikontode arv") +
    geom_point(data = filter(koguturu_kontod, Kuupäev == max(Kuupäev)),
               size = 2, color = "orange") +
    geom_text(data = filter(koguturu_kontod, Kuupäev == max(Kuupäev)),
              aes(label = kontode_label), nudge_x = 180, color = "orange")

  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

:::


# Fondide võrdlus

```{r calc_market_share, include=FALSE}
if(nrow(fondid_info) > 0) {
  # Arvutame iga fondi turuosa MAHU järgi
  # NB! Kontode arvu ei saa fondi-põhiselt arvutada, kuna API seda ei paku
  fondid_turuosa <- fondid_info %>%
    group_by(Kuupäev) %>%
    mutate(
      turuosa_maht = round(100 * maht / sum(maht, na.rm = TRUE), 1)
    )

  # Võtame TOP 10 fondi viimase kuupäeva järgi
  maksp2ev <- max(fondid_turuosa$Kuupäev, na.rm = TRUE)
  top_fondid <- fondid_turuosa %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(maht)) %>%
    head(10) %>%
    pull(Lühinimi)

  fondid_top <- fondid_turuosa %>%
    filter(Lühinimi %in% top_fondid)

  # Värvid TOP fondidele
  top_arv <- length(unique(fondid_top$Lühinimi))
  colors_top <- c("#e60049", "#50e991", "#e6d800", "#9b19f5", "#ffa300",
                  "#dc0ab4", "#b3d4ff", "#00bfa0", "#ff6e54", "#444e86")[1:top_arv]
  names(colors_top) <- unique(fondid_top$Lühinimi)
} else {
  fondid_top <- data.frame()
}
```

::: panel-tabset

#### Turuosa mahu järgi

```{r plot_market_share_volume}
if(nrow(fondid_top) > 0) {
  maksp2ev <- max(fondid_top$Kuupäev, na.rm = TRUE)
  viimanep2ev <- fondid_top %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(turuosa_maht))

  p <- fondid_top %>%
    mutate(Lühinimi = factor(Lühinimi, levels = viimanep2ev$Lühinimi)) %>%
    ggplot(aes(x = Kuupäev, y = turuosa_maht)) +
    geom_line(aes(color = Lühinimi)) +
    theme_ft_rc() +
    scale_color_manual(values = colors_top) +
    labs(x = "kuupäev", y = "turuosa (%)",
         title = "TOP 10 fondi turuosa mahu järgi")
  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

#### Maht

```{r plot_volume}
if(nrow(fondid_top) > 0) {
  maksp2ev <- max(fondid_top$Kuupäev, na.rm = TRUE)
  viimanep2ev <- fondid_top %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(maht))

  fondid_top <- fondid_top %>%
    mutate(maht_milj = round(maht / 1000000, 1))

  p <- fondid_top %>%
    mutate(Lühinimi = factor(Lühinimi, levels = viimanep2ev$Lühinimi)) %>%
    ggplot(aes(x = Kuupäev, y = maht_milj)) +
    geom_line(aes(color = Lühinimi)) +
    theme_ft_rc() +
    scale_color_manual(values = colors_top) +
    labs(x = "kuupäev", y = "fondi maht (milj eurot)",
         title = "TOP 10 fondi mahud")
  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

:::


```{r save_csv, include=FALSE}
# Salvestame andmed CSV-sse
if(nrow(fondid_info) > 0) {
  write_csv(k6ik_koos, file = "iii_sammas_koguturg.csv")

  if(nrow(fondid_top) > 0) {
    write_csv(fondid_top, file = "iii_sammas_top_fondid.csv")
  }
}
```


**Andmeallikad:**

- Pensionikontode arv: [Pensionikeskus III sammas](https://www.pensionikeskus.ee/statistika/iii-sammas/pensionikontode-arv/)
- Fondide maht: [Pensionikeskus III sammas](https://www.pensionikeskus.ee/statistika/iii-sammas/taiendava-kogumispensioni-fondide-maht/)

