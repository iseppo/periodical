---
title: "Kolmas sammas - turuülevaade"
date: today
date-format: long
lang: et_EE
format:
  html:
    toc: true
    toc-depth: 3
    toc-title: Sisukord
    toc-location: right
    number-sections: false
    number-depth: 3
    html-math-method: katex
    self-contained: true
    anchor-sections: true
    smooth-scroll: true
    theme: slate
execute:
  echo: false
  warning: false
  message: false
---



```{r setup, message=FALSE}
library(dplyr)
library(tidyr)
library(forcats)
library(ggplot2)
library(readr)
library(stringr)
library(lubridate)
library(hrbrthemes)
library(plotly)
library(jsonlite)
library(rvest)
library(tibble)
```

```{r config, echo=FALSE, message=FALSE, warning=FALSE}
from_day <- "2017-05-02"
yesterday <- as.character(today() - days(1))
options(scipen = 999)

# Baasvärvid graafikutele (ühtne palett kogu dokumendis)
BAASVÄRVID <- c("#e60049", "#50e991", "#e6d800", "#9b19f5", "#ffa300",
                "#dc0ab4", "#b3d4ff", "#00bfa0", "#ff6e54", "#444e86")

# Omistab värvid fondide nimedele
omista_varvid <- function(nimed) {
  n <- length(nimed)
  värvid <- rep(BAASVÄRVID, ceiling(n / length(BAASVÄRVID)))[1:n]
  names(värvid) <- nimed
  värvid
}

# Eemaldab "pensionifond" sõna ja puhastab tühikud
puhasta_fondinimi <- function(nimi) {
  str_trim(str_replace_all(nimi, regex("pensionifond", ignore_case = TRUE), ""))
}

# Leiab viimase kuupäeva, kus kõigil fondidel on andmed
leia_taispaev <- function(df, fondi_veerg = "Lühinimi") {
  fondide_arv <- df %>%
    group_by(Kuupäev) %>%
    summarise(n = n_distinct(.data[[fondi_veerg]]), .groups = "drop")
  max_n <- max(fondide_arv$n, na.rm = TRUE)
  fondide_arv %>%
    filter(n == max_n) %>%
    pull(Kuupäev) %>%
    max(na.rm = TRUE)
}
```


```{r fondid_online}
# Määrame fondid ja nende ID-d käsitsi, et vältida veebilehe vigadest tulenevaid probleeme.
# ID-d pärinevad Pensionikeskuse süsteemist.

fondid <- data.frame(
  id = c("78", "47", "48", "82",    # LHV
         "77", "50", "51",          # Swedbank
         "79", "44",                # SEB
         "76", "75",                # Luminor
         "80"),                     # Tuleva
  fond = c("LHV III Indeks", "LHV III Täiendav", "LHV III XL", "LHV III Roheline",
           "Swedbank III V100 Indeks", "Swedbank III V30", "Swedbank III V60",
           "SEB III Tulevik Indeks", "SEB III Aktiivne",
           "Luminor III Jätkusuutlik", "Luminor III Aktsiad 100",
           "Tuleva III"),
  indeks = c("x", "", "", "",       # Märgime indeksfondid (x)
             "x", "", "",
             "x", "",
             "x", "",
             "x"),
  stringsAsFactors = FALSE
)

# Jätame meelde ka fund_info, et ülejäänud kood katki ei läheks
fund_info <- fondid %>% rename(ID = id, Title = fond)
```



```{r lae_alla_info, message=FALSE, warning=FALSE}
# Määrame, millisest kuupäevast alates andmeid laadida
csv_ajalugu <- "iii_sammas_ajalugu.csv"

# UUENDUS: Laeme ALATI alla olemasoleva andmebaasi veebiserverist
andmebaas_url <- "https://www.seppo.ai/tuleva/iii_sammas_ajalugu.csv"

# Püüame alla laadida andmebaasi (isegi kui lokaalne fail eksisteerib)
message("Püüan laadida alla andmebaasi veebiserverist...")
andmebaas_laaditud <- FALSE
tryCatch({
  dl_status <- download.file(andmebaas_url, csv_ajalugu, method = "auto", quiet = TRUE)
  if(dl_status == 0 && file.exists(csv_ajalugu) && file.size(csv_ajalugu) > 0) {
    message("✓ Andmebaas edukalt alla laaditud veebiserverist")
    andmebaas_laaditud <- TRUE
  } else if(dl_status != 0) {
    message("ℹ Allalaadimine ebaõnnestus (kood: ", dl_status, ")")
  }
}, error = function(e) {
  message("ℹ Andmebaasi ei saanud alla laadida (fail võib-olla ei eksisteeri veel): ", e$message)
  message("  Jätkan ilma andmebaasita või kasutan lokaalselt olemasolevat faili")
})

if(file.exists(csv_ajalugu)) {
  # Kui CSV eksisteerib, laeme ainult viimased 7 päeva
  vanad_andmed <- read_csv(csv_ajalugu, show_col_types = FALSE)
  viimane_kuupaev <- max(vanad_andmed$Kuupäev, na.rm = TRUE)
  from_day <- as.character(viimane_kuupaev - days(1))
  message("Laadime andmeid alates ", from_day, " (CSV fail eksisteerib)")
} else {
  # Kui CSV ei eksisteeri, laeme kogu ajaloo
  from_day <- "2017-05-02"
  message("Laadime kogu ajaloo alates ", from_day)
}

# 1. TÄIUSTATUD FUNKTSIOONID
# Eemaldab ka "hard space" (\u00a0) ja tavalised tühikud
puhasta_number <- function(x) {
  if(is.numeric(x)) return(x)
  if(is.character(x)) {
    # Asendame kõik tühiku-laadsed märgid (sh non-breaking space) tühjusega
    x_puhastatud <- gsub("\\s|\\u00a0", "", x) 
    x_puhastatud <- gsub(",", ".", x_puhastatud, fixed = TRUE)
    return(as.numeric(x_puhastatud))
  }
  return(as.numeric(x))
}

# Otsib veergu täpsema mustri järgi
leia_veerg_taern <- function(df, muster) {
  # Otsime veergu, mis sisaldab mustrit
  veerg <- grep(muster, names(df), ignore.case = TRUE, value = TRUE)
  # Välistame "Osakute arv", kui otsime kontosid
  if(grepl("konto", muster, ignore.case=TRUE)) {
     veerg <- veerg[!grepl("osak", veerg, ignore.case=TRUE)]
  }
  if(length(veerg) > 0) return(veerg[1])
  return(NULL)
}

# 2. ANDMETE LAADIMINE

# Laeme KÕIKIDE fondide mahu korraga (kõik fond ID-d)
lae_mahud <- function(from_day, yesterday) {
  # Kasutame fondid tabelist fondide ID-d (dünaamiline, mitte hardcoded)
  all_fund_ids <- fondid$id
  fund_params <- paste0("&f[]=", all_fund_ids, collapse = "")

  url <- paste0("https://www.pensionikeskus.ee/statistika/iii-sammas/taiendava-kogumispensioni-fondide-maht/?download=xls",
                "&date_from=", from_day, "&date_to=", yesterday,
                fund_params)

  tryCatch({
    df <- read.delim(url, fileEncoding = "UTF-16LE", header = TRUE,
                    check.names = FALSE, stringsAsFactors = FALSE, dec = ",")

    if("Kuupäev" %in% names(df)) df$Kuupäev <- dmy(df$Kuupäev)

    # Leiame mahtu veeru
    col_maht <- leia_veerg_taern(df, "maht")
    if(!is.null(col_maht)) {
      df$maht <- puhasta_number(df[[col_maht]])
    }

    # Lisame ISIN-i põhjal fondi ID (match with our fondid list)
    # Kui ISIN puudub, kasutame fondi nime
    return(df %>% select(Kuupäev, Fond, Lühinimi, maht))
  }, error = function(e) {
    message("Viga mahtude laadimisel: ", e$message)
    return(NULL)
  })
}

# Laeme KOGUTURU kontode arvu (see on juba summa üle kõikide fondide!)
lae_koguturu_kontod <- function(from_day, yesterday) {
  url <- paste0("https://www.pensionikeskus.ee/statistika/iii-sammas/pensionikontode-arv/?download=xls",
                "&date_from=", from_day, "&date_to=", yesterday)

  tryCatch({
    df <- read.delim(url, fileEncoding = "UTF-16LE", header = TRUE,
                    check.names = FALSE, stringsAsFactors = FALSE, dec = ",")

    if("Kuupäev" %in% names(df)) df$Kuupäev <- dmy(df$Kuupäev)

    col <- leia_veerg_taern(df, "pensionikontode.*arv")
    if(!is.null(col)) {
      df$kontode_arv_koguturg <- puhasta_number(df[[col]])
      return(df %>% select(Kuupäev, kontode_arv_koguturg))
    }
    return(NULL)
  }, error = function(e) {
    message("Viga kontode arvu laadimisel: ", e$message)
    return(NULL)
  })
}

# Laeme OSAKUOMANIKE arvu (fondi-põhine investorite/kontohoidjate arv!)
# See pärineb peamisest statistika tabelist ja sisaldab "Osak. arv" veergu
lae_osakuomanikud <- function() {
  url <- "https://www.pensionikeskus.ee/statistika/iii-sammas/taiendava-kogumispensioni-statistika/?download=xls"

  tryCatch({
    df <- read.delim(url, fileEncoding = "UTF-16LE", header = TRUE,
                    check.names = FALSE, stringsAsFactors = FALSE, dec = ",")

    # Leiame õiged veerud
    col_fond <- names(df)[1]  # Esimene veerg on fond
    col_osak <- leia_veerg_taern(df, "osak.*arv")

    if(!is.null(col_osak)) {
      df$osakuomanikud <- puhasta_number(df[[col_osak]])
      result <- df %>%
        select(Fond = !!col_fond, osakuomanikud) %>%
        filter(!is.na(osakuomanikud))

      message("Laaditud ", nrow(result), " fondi osakuomanike arvud (kokku: ",
              format(sum(result$osakuomanikud, na.rm=TRUE), big.mark=" "), ")")
      return(result)
    }
    return(NULL)
  }, error = function(e) {
    message("Viga osakuomanike laadimisel: ", e$message)
    return(NULL)
  })
}

# Laeme andmed
raw_maht <- lae_mahud(from_day, yesterday)
raw_koguturu_kontod <- lae_koguturu_kontod(from_day, yesterday)
raw_osakuomanikud <- lae_osakuomanikud()

# 3. ANDMETE ÜHENDAMINE
if(!is.null(raw_maht) && nrow(raw_maht) > 0) {

  # Puhastame fondide nimed ja ühendame indeksi info fondid tabelist
  fondid_info <- raw_maht %>%
    mutate(
      Fond = puhasta_fondinimi(Fond),
      Lühinimi = puhasta_fondinimi(Lühinimi)
    ) %>%
    left_join(fondid %>% select(fond, indeks), by = c("Lühinimi" = "fond")) %>%
    mutate(indeks = ifelse(is.na(indeks), "", indeks))

  # Lisame osakuomanike (kontode) arvu viimase kuupäeva kohta
  # Pensionikeskus avaldab seda ainult värskeima seisu kohta, nii et
  # ajaloo ehitame üles jooksvalt CSV faili täiendades.
  viimane_kuupaev <- max(fondid_info$Kuupäev, na.rm = TRUE)
  fondid_info <- fondid_info %>% mutate(osakuomanikud = NA_integer_)

  if(!is.null(raw_osakuomanikud) && nrow(raw_osakuomanikud) > 0) {
    osakuomanikud_puhas <- raw_osakuomanikud %>%
      mutate(
        Fond = puhasta_fondinimi(Fond),
        osakuomanikud_uus = as.integer(osakuomanikud)
      ) %>%
      select(Fond, osakuomanikud_uus)

    fondid_info <- fondid_info %>%
      left_join(osakuomanikud_puhas, by = "Fond") %>%
      mutate(
        osakuomanikud = ifelse(Kuupäev == viimane_kuupaev, osakuomanikud_uus, osakuomanikud)
      ) %>%
      select(-osakuomanikud_uus)

    message("✓ Lisatud osakuomanike arv viimase kuupäeva (", viimane_kuupaev, ") kohta")
  } else {
    message("ℹ Osakuomanike andmeid ei õnnestunud laadida – jätame veeru tühjaks")
  }

  message("Laaditud fondide arv: ", length(unique(fondid_info$Fond)))

  # SALVESTAME ANDMED CSV-SSE
  if(file.exists(csv_ajalugu)) {
    # Loe olemasolevad andmed
    vanad_andmed <- read_csv(csv_ajalugu, show_col_types = FALSE)

    # Kui vanas failis puuduvad veerud, lisame need
    if(!"osakuomanikud" %in% names(vanad_andmed)) {
      vanad_andmed <- vanad_andmed %>% mutate(osakuomanikud = NA_integer_)
    }
    if(!"indeks" %in% names(vanad_andmed)) {
      vanad_andmed <- vanad_andmed %>% mutate(indeks = "")
    }

    # Leia uued read (kuupäevad + fondid, mida ei ole veel CSV-s)
    uued_read <- fondid_info %>%
      anti_join(vanad_andmed, by = c("Kuupäev", "Lühinimi"))

    if(nrow(uued_read) > 0) {
      # Lisa uued read ja salvesta
      kokku <- bind_rows(vanad_andmed, uued_read) %>%
        arrange(Kuupäev)
      write_csv(kokku, csv_ajalugu)
      message("✓ Lisatud ", nrow(uued_read), " uut rida ajaloo faili (",
              length(unique(uued_read$Kuupäev)), " uut kuupäeva)")

      # Kasutame täielikku andmestikku graafikute jaoks
      fondid_info <- kokku
    } else {
      message("ℹ Uusi andmeid ei ole, CSV juba ajakohane")
      # Kasutame täielikku andmestikku graafikute jaoks
      fondid_info <- vanad_andmed
    }
  } else {
    # Kui CSV ei eksisteeri, salvesta kõik andmed
    write_csv(fondid_info, csv_ajalugu)
    message("✓ Loodud uus ajaloo fail: ", csv_ajalugu, " (", nrow(fondid_info), " rida)")
  }

} else {
  fondid_info <- data.frame()
  message("Andmete laadimine ebaõnnestus.")
}

# SALVESTAME INVESTORITE ARVU AJALOO
# Pensionikeskus avaldab osakuomanike arvu ainult viimase kuupäeva kohta,
# seega ehitame ajaloo üles jooksvalt CSV faili täiendades.
if(!is.null(raw_osakuomanikud) && nrow(raw_osakuomanikud) > 0) {
  csv_investorid_ajalugu <- "iii_sammas_investorid_ajalugu.csv"
  investorid_andmebaas_url <- "https://www.seppo.ai/tuleva/iii_sammas_investorid_ajalugu.csv"

  # Laeme ALATI alla olemasoleva andmebaasi veebiserverist
  message("Püüan laadida alla investorite andmebaasi veebiserverist...")
  tryCatch({
    dl_status <- download.file(investorid_andmebaas_url, csv_investorid_ajalugu, method = "auto", quiet = TRUE)
    if(dl_status == 0 && file.exists(csv_investorid_ajalugu) && file.size(csv_investorid_ajalugu) > 0) {
      message("✓ Investorite andmebaas edukalt alla laaditud veebiserverist")
    } else if(dl_status != 0) {
      message("ℹ Investorite andmebaasi allalaadimine ebaõnnestus (kood: ", dl_status, ")")
    }
  }, error = function(e) {
    message("ℹ Investorite andmebaasi ei saanud alla laadida (fail võib-olla ei eksisteeri veel): ", e$message)
    message("  Loome uue faili")
  })

  # Valmistame ette täna laaditud osakuomanike andmed
  # Lisame tänase kuupäeva (eile, kuna andmed on eile seisuga)
  tanamased_investorid <- raw_osakuomanikud %>%
    mutate(
      Fond = puhasta_fondinimi(Fond),
      Kuupäev = as.Date(yesterday),
      investorite_arv = as.integer(osakuomanikud)
    ) %>%
    select(Kuupäev, Fond, investorite_arv)

  if(file.exists(csv_investorid_ajalugu)) {
    # Kui CSV eksisteerib, loeme sisse ja lisame uued andmed
    vanad_investorid <- read_csv(csv_investorid_ajalugu, show_col_types = FALSE)

    # Kontrollime, kas täna kuupäev juba eksisteerib
    uued_investorid <- tanamased_investorid %>%
      anti_join(vanad_investorid, by = c("Kuupäev", "Fond"))

    if(nrow(uued_investorid) > 0) {
      # Lisa uued read ja salvesta
      kokku_investorid <- bind_rows(vanad_investorid, uued_investorid) %>%
        arrange(Kuupäev, Fond)
      write_csv(kokku_investorid, csv_investorid_ajalugu)
      message("✓ Lisatud ", nrow(uued_investorid), " uut rida investorite ajaloo faili (",
              length(unique(uued_investorid$Fond)), " fondi)")
    } else {
      message("ℹ Investorite andmed juba ajakohased")
    }
  } else {
    # Kui CSV ei eksisteeri, salvesta kõik andmed
    write_csv(tanamased_investorid, csv_investorid_ajalugu)
    message("✓ Loodud uus investorite ajaloo fail: ", csv_investorid_ajalugu,
            " (", nrow(tanamased_investorid), " rida)")
  }
} else {
  message("ℹ Investorite andmeid ei saanud laadida – investorite ajalugu ei uuenenud")
}
```




```{r filter_index_funds, message=FALSE, warning=FALSE, include=FALSE}
# Filtreerime indeksfondid, kui need on märgitud
if(nrow(fondid_info) > 0) {
  # Kasutame 'indeks' veergu, mis lisati fondid tabelist
  indeksfondid <- fondid_info %>%
    filter(!is.na(indeks) & indeks == "x")
} else {
  indeksfondid <- fondid_info
}
```


```{r set_colors, include=FALSE}
# Määrame värvid
if(nrow(indeksfondid) > 0) {
  colors_fondid <- omista_varvid(unique(indeksfondid$Lühinimi))
}
```


```{r date_range, include=FALSE}
if(nrow(fondid_info) > 0) {
  andmed_alates <- min(fondid_info$Kuupäev, na.rm = TRUE)
  andmed_kuni <- max(fondid_info$Kuupäev, na.rm = TRUE)
} else {
  andmed_alates <- NA
  andmed_kuni <- NA
}
```

# Kolmanda samba ülevaade

```{r print_date_range}
if(nrow(fondid_info) > 0) {
  cat("Andmed:", as.character(andmed_alates), "--", as.character(andmed_kuni), "\n")
} else {
  cat("Andmete laadimine ebaõnnestus. Palun kontrolli Pensionifondid_III.csv faili ja veendu, et seal on fondide ID-d määratud.\n\nVõid kasutada skripti fetch_iii_sammas_fondid.R fondide nimekirja hankimiseks.")
}
```

::: panel-tabset


```{r calc_totals, include=FALSE}
if(nrow(fondid_info) > 0) {
  # Arvutame kogusumma MAHU kohta (kontode arvu ajalugu koguneb jooksvalt)
  k6ik_koos <- fondid_info %>%
    group_by(Kuupäev) %>%
    summarize(
      maht_kokku = sum(maht, na.rm = TRUE)
    )

  # Lisame koguturu kontode arvu (see on ajaloo kohta!)
  if(!is.null(raw_koguturu_kontod) && nrow(raw_koguturu_kontod) > 0) {
    k6ik_koos <- k6ik_koos %>%
      left_join(raw_koguturu_kontod, by = "Kuupäev")
  } else {
    k6ik_koos <- k6ik_koos %>%
      mutate(kontode_arv_koguturg = NA_integer_)
  }

  if(nrow(indeksfondid) > 0) {
    indeksfondid_koos <- indeksfondid %>%
      group_by(Kuupäev) %>%
      summarize(
        maht = sum(maht, na.rm = TRUE)
      ) %>%
      left_join(k6ik_koos, by = "Kuupäev") %>%
      mutate(
        indeks_maht_protsent = ifelse(maht_kokku > 0, round(100 * maht / maht_kokku, 1), 0)
      )
  } else {
    indeksfondid_koos <- k6ik_koos %>%
      mutate(
        maht = 0,
        indeks_maht_protsent = 0
      )
  }
} else {
  indeksfondid_koos <- data.frame()
  k6ik_koos <- data.frame()
}
```

#### Koguturu maht

```{r plot_total_volume}
if(nrow(k6ik_koos) > 0) {
  koguturu_maht <- k6ik_koos %>%
    mutate(maht_milj = round(maht_kokku / 1000000, 1)) %>%
    mutate(maht_label = format(maht_milj, big.mark = " ", decimal.mark = ","))

  p <- koguturu_maht %>%
    ggplot(aes(x = Kuupäev, y = maht_milj)) +
    geom_line() +
    theme_ft_rc() +
    geom_blank(aes(x = min(Kuupäev), y = 0)) +
    labs(title = "Kolmanda samba koguturu maht",
         x = "kuupäev",
         y = "maht (miljonit eurot)") +
    geom_point(data = filter(koguturu_maht, Kuupäev == max(Kuupäev)),
               size = 2, color = "orange") +
    geom_text(data = filter(koguturu_maht, Kuupäev == max(Kuupäev)),
              aes(label = maht_label), nudge_x = 150, color = "orange")

  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```


#### Koguturu kontod

```{r plot_total_accounts}
if(nrow(k6ik_koos) > 0 && !is.null(k6ik_koos$kontode_arv_koguturg)) {
  koguturu_kontod <- k6ik_koos %>%
    filter(!is.na(kontode_arv_koguturg)) %>%
    mutate(kontode_label = format(kontode_arv_koguturg, big.mark = " ", decimal.mark = ","))

  p <- koguturu_kontod %>%
    ggplot(aes(x = Kuupäev, y = kontode_arv_koguturg)) +
    geom_line() +
    theme_ft_rc() +
    geom_blank(aes(x = min(Kuupäev), y = 0)) +
    labs(title = "Kolmanda samba pensionikontode arv (koguturg)",
         x = "kuupäev",
         y = "pensionikontode arv") +
    geom_point(data = filter(koguturu_kontod, Kuupäev == max(Kuupäev)),
               size = 2, color = "orange") +
    geom_text(data = filter(koguturu_kontod, Kuupäev == max(Kuupäev)),
              aes(label = kontode_label), nudge_x = 180, color = "orange")

  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

#### Indeksfondide osakaal

```{r plot_index_share}
if(nrow(indeksfondid_koos) > 0) {
  indeksfondid_plot <- indeksfondid_koos %>%
    filter(!is.na(indeks_maht_protsent))

  viimane <- indeksfondid_plot %>% filter(Kuupäev == max(Kuupäev))
  viimane_label <- paste0(format(viimane$indeks_maht_protsent, decimal.mark = ","), "%")

  p <- indeksfondid_plot %>%
    ggplot(aes(x = Kuupäev, y = indeks_maht_protsent)) +
    geom_line() +
    theme_ft_rc() +
    geom_blank(aes(x = min(Kuupäev), y = 0)) +
    labs(title = "Indeksfondide osakaal koguturu mahust",
         x = "kuupäev",
         y = "osakaal (%)") +
    geom_point(data = viimane, size = 2, color = "orange") +
    geom_text(data = viimane,
              aes(label = viimane_label), nudge_x = 150, color = "orange")

  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

:::


# Fondide võrdlus

```{r calc_market_share, include=FALSE}
if(nrow(fondid_info) > 0) {
  # Arvutame iga fondi turuosa MAHU järgi (kontode arvu ajalugu koguneb jooksvalt)
  fondid_turuosa <- fondid_info %>%
    group_by(Kuupäev) %>%
    mutate(
      turuosa_maht = if (sum(maht, na.rm = TRUE) > 0)
                           round(100 * maht / sum(maht, na.rm = TRUE), 1) else rep(0, n())
    )

  # Leiame viimase kuupäeva, kus kõigil fondidel on andmed olemas
  maksp2ev <- leia_taispaev(fondid_turuosa)
  message("Kasutame kuupäeva ", maksp2ev)

  # Võtame KÕIK fondid sellel kuupäeval
  top_fondid <- fondid_turuosa %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(maht)) %>%
    pull(Lühinimi)

  fondid_top <- fondid_turuosa %>%
    filter(Lühinimi %in% top_fondid)

  # Värvid kõigile fondidele
  colors_top <- omista_varvid(unique(fondid_top$Lühinimi))
} else {
  fondid_turuosa <- data.frame()
  fondid_top <- data.frame()
}

# Arvutame turuosa kontode järgi AINULT viimase päeva kohta (osakuomanikud)
if(!is.null(raw_osakuomanikud) && nrow(raw_osakuomanikud) > 0) {
  kontode_turuosa_viimane <- raw_osakuomanikud %>%
    mutate(
      Fond = puhasta_fondinimi(Fond),
      turuosa_kontod = if (sum(osakuomanikud, na.rm = TRUE) > 0)
                             round(100 * osakuomanikud / sum(osakuomanikud, na.rm = TRUE), 1) else rep(0, n())
    ) %>%
    arrange(desc(osakuomanikud))

  # Värvid kontode graafikutele
  colors_kontod <- omista_varvid(kontode_turuosa_viimane$Fond)

  message("✓ Arvutatud turuosa kontode järgi viimase päeva kohta (",
          nrow(kontode_turuosa_viimane), " fondi)")
} else {
  kontode_turuosa_viimane <- data.frame()
  message("! Kontode turuosa andmed puuduvad")
}
```

::: panel-tabset

#### Turuosa kontode järgi

```{r plot_market_share_accounts}
if(nrow(kontode_turuosa_viimane) > 0) {
  # MÄRKUS: Kontode arvu ajalugu ei ole saadaval
  # Seetõttu näitame AINULT viimase päeva turuosa (barplot)

  p <- kontode_turuosa_viimane %>%
    mutate(Fond = factor(Fond, levels = Fond)) %>%
    ggplot(aes(x = Fond, y = turuosa_kontod, fill = Fond)) +
    geom_col() +
    theme_ft_rc() +
    scale_fill_manual(values = colors_kontod) +
    labs(x = "", y = "turuosa (%)",
         title = "Fondide turuosa kontode arvu järgi (viimane päev)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  ggplotly(p)
} else {
  cat("Kontode arvu andmed puuduvad (ei saa ajalugu alla laadida)")
}
```

#### Turuosa mahu järgi

```{r plot_market_share_volume}
if(nrow(fondid_top) > 0) {
  maksp2ev <- max(fondid_top$Kuupäev, na.rm = TRUE)
  viimanep2ev <- fondid_top %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(turuosa_maht))

  p <- fondid_top %>%
    mutate(Lühinimi = factor(Lühinimi, levels = viimanep2ev$Lühinimi)) %>%
    ggplot(aes(x = Kuupäev, y = turuosa_maht)) +
    geom_line(aes(color = Lühinimi)) +
    theme_ft_rc() +
    scale_color_manual(values = colors_top) +
    labs(x = "kuupäev", y = "turuosa (%)",
         title = "Fondide turuosa mahu järgi")
  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

#### Kontode arv

```{r plot_accounts_count}
if(nrow(kontode_turuosa_viimane) > 0) {
  # MÄRKUS: Kontode arvu ajalugu ei ole saadaval
  # Seetõttu näitame AINULT viimase päeva andmed (barplot)

  p <- kontode_turuosa_viimane %>%
    mutate(Fond = factor(Fond, levels = Fond)) %>%
    ggplot(aes(x = Fond, y = osakuomanikud, fill = Fond)) +
    geom_col() +
    theme_ft_rc() +
    scale_fill_manual(values = colors_kontod) +
    labs(x = "", y = "osakuomanike arv",
         title = "Fondide osakuomanike arv (viimane päev)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  ggplotly(p)
} else {
  cat("Kontode arvu andmed puuduvad (ei saa ajalugu alla laadida)")
}
```

#### Maht

```{r plot_volume}
if(nrow(fondid_top) > 0) {
  maksp2ev <- max(fondid_top$Kuupäev, na.rm = TRUE)
  viimanep2ev <- fondid_top %>%
    filter(Kuupäev == maksp2ev) %>%
    arrange(desc(maht))

  fondid_top <- fondid_top %>%
    mutate(maht_milj = round(maht / 1000000, 1))

  p <- fondid_top %>%
    mutate(Lühinimi = factor(Lühinimi, levels = viimanep2ev$Lühinimi)) %>%
    ggplot(aes(x = Kuupäev, y = maht_milj)) +
    geom_line(aes(color = Lühinimi)) +
    theme_ft_rc() +
    scale_color_manual(values = colors_top) +
    labs(x = "kuupäev", y = "fondi maht (milj eurot)",
         title = "Fondide mahud")
  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

#### Turuosa (barplot)

```{r plot_marketshare_barplot}
if(nrow(fondid_turuosa) > 0) {
  maksp2ev <- leia_taispaev(fondid_turuosa)

  # Võtame KÕIK fondid TURUOSA järgi
  top_turuosa <- fondid_turuosa %>%
    filter(Kuupäev == maksp2ev, !is.na(turuosa_maht)) %>%
    arrange(desc(turuosa_maht))

  colors_turuosa <- omista_varvid(top_turuosa$Lühinimi)

  p <- top_turuosa %>%
    mutate(Lühinimi = factor(Lühinimi, levels = Lühinimi)) %>%
    ggplot(aes(x = Lühinimi, y = turuosa_maht, fill = Lühinimi)) +
    geom_col() +
    theme_ft_rc() +
    scale_fill_manual(values = colors_turuosa) +
    labs(x = "", y = "turuosa (%)",
         title = paste0("Fondide turuosa (", maksp2ev, ")")) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  ggplotly(p)
} else {
  cat("Andmed puuduvad")
}
```

#### Investorite ajalugu

```{r plot_investor_history}
csv_investorid_ajalugu <- "iii_sammas_investorid_ajalugu.csv"
if(file.exists(csv_investorid_ajalugu)) {
  investorid_ajalugu <- read_csv(csv_investorid_ajalugu, show_col_types = FALSE)

  if(nrow(investorid_ajalugu) > 0) {
    colors_inv <- omista_varvid(unique(investorid_ajalugu$Fond))

    # Sortime fondid viimase päeva investorite arvu järgi
    viimane_kp <- max(investorid_ajalugu$Kuupäev, na.rm = TRUE)
    fondide_jarjestus <- investorid_ajalugu %>%
      filter(Kuupäev == viimane_kp) %>%
      arrange(desc(investorite_arv)) %>%
      pull(Fond)

    p <- investorid_ajalugu %>%
      mutate(Fond = factor(Fond, levels = fondide_jarjestus)) %>%
      ggplot(aes(x = Kuupäev, y = investorite_arv, color = Fond)) +
      geom_line() +
      theme_ft_rc() +
      scale_color_manual(values = colors_inv) +
      labs(title = "Osakuomanike arvu ajalugu",
           x = "kuupäev",
           y = "osakuomanike arv")
    ggplotly(p)
  } else {
    cat("Investorite ajaloo andmed puuduvad")
  }
} else {
  cat("Investorite ajaloo fail puudub (koguneb jooksvalt)")
}
```

:::


```{r save_csv, include=FALSE}
# Salvestame andmed CSV-sse
if(nrow(fondid_info) > 0) {
  write_csv(k6ik_koos, file = "iii_sammas_koguturg.csv")

  if(nrow(fondid_top) > 0) {
    write_csv(fondid_top, file = "iii_sammas_top_fondid.csv")
  }
}
```


**Andmeallikad:**

- Pensionikontode arv: [Pensionikeskus III sammas](https://www.pensionikeskus.ee/statistika/iii-sammas/pensionikontode-arv/)
- Fondide maht: [Pensionikeskus III sammas](https://www.pensionikeskus.ee/statistika/iii-sammas/taiendava-kogumispensioni-fondide-maht/)

